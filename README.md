Certificate Authority
=========

Adds a locally-trusted Certificate Authority and associated helper scripts to simplify creating internal certificates.

There is a Root -> Intermediate structure and all certs generated by this CA can be trusted by importing a single root certificate. This is easier to manage than individual self-signed certificates.

All generated certificates will have Subject Alternate Names (SAN) by default, and support multiple names.

Requirements
------------

Requires OpenSSL (will be installed by role if absent).

Requires a JDK if Java Keystores are needed (keytool). Silently ignores JKS generation if absent.

Role Variables
--------------

```YAML
ca_base_dir: /root/ca
ca_owner: root
ca_group: root
ca_common_name: "Example Co Root CA"
ca_country_name: "US"
ca_state_or_province_name: "New York"
ca_organization_name: "Example Co"
ca_valid_days: 18250
inter_ca_common_name: "Example Co Intermediate CA"
inter_ca_country_name: "US"
inter_ca_state_or_province_name: "New York"
inter_ca_organization_name: "Example Co"
inter_ca_valid_days: 16425
signed_cert_valid_days: 3750
trust_local_ca: True
```


Example Playbook
----------------
```YAML
---
- name: local CA role application
  hosts: localhost
  roles:
    - role: erinish.certificate_authority
      ca_common_name: "Hollywoo Root CA"
      ca_state_or_province_name: "California"
      ca_organization_name: "Hollywoo"
      inter_ca_common_name: "Hollywoo Intermediate CA"
      inter_ca_state_or_province_name: "California"
      inter_ca_organization_name: "Hollywoo"
      signed_cert_valid_days: 30
```

Using the CA in a Playbook
--------------------------

Here is a short example where the local CA is used to generate new certs
and move them to a directory. You could also push them to remote servers, slurp them, etc. 

The generated cert is for test.example.com with SAN for test.example.com and dev.example.com

```YAML
---
- name: Test generating and placing a certificate
  hosts: localhost
  vars:
    ca_bin: /home/devops/ca/local-ca.sh
  tasks:
    - name: Generate new certs
      command: "{{ ca_bin }} gen test.example.com dev.example.com"
      register: cert_dir

    - name: Pickup new certs
      synchronize:
        src: "{{ cert_dir.stdout }}/{{ item }}"
        dest: "/etc/nginx/ssl/{{ item }}"
      loop:
        - test.example.com.crt
        - test.example.com.key
        - ca-chain.crt
```

Using the CA on the CLI
-----------------------

The CA can be used outside ansible to generate certs or even sign CSRs.

```BASH
$ cd /root/ca

$ ./local-ca.sh gen mycert.example.com
/home/devops/ca/intermediate/bundles/mycert.example.com-2018-08-04-9ca15dc9/

$ cd /home/devops/ca/intermediate/bundles/mycert.example.com-2018-08-04-9ca15dc9/

$ ls
ca-chain.crt  mycert.example.com.crt  mycert.example.com.csr  mycert.example.com.jks  mycert.example.com.key  mycert.example.com-nginx.crt  mycert.example.com.p12  readme.txt
```


License
-------

MIT
